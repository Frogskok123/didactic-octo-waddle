name: Build rwProcMem33 (test)

on: 
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu libelf-dev bc bison flex libssl-dev git
    
    - name: Clone rwProcMem33
      run: |
        git clone https://github.com/abcz316/rwProcMem33.git
        
        echo "=== Driver location ==="
        ls -la rwProcMem33/rwProcMem33Module/rwProcMem_module/
    
    - name: Download kernel
      run: |
        git clone --depth=1 --branch android12-5.10-lts \
          https://android.googlesource.com/kernel/common kernel
    
    - name: Configure kernel
      run: |
        cd kernel
        sed -i 's/^SUBLEVEL = .*/SUBLEVEL = 136/' Makefile
        sed -i 's|^EXTRAVERSION =.*|EXTRAVERSION = -android12-9-00020-gc9f59ef34367-ab9585114|' Makefile
        echo "" > .scmversion
        
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- gki_defconfig
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- modules_prepare -j$(nproc)
    
    - name: Show rwProcMem Makefile
      run: |
        MODULE_DIR=$(pwd)/rwProcMem33/rwProcMem33Module/rwProcMem_module
        
        echo "=== Their Makefile (learn from this!) ==="
        cat "$MODULE_DIR/Makefile"
        
        echo ""
        echo "=== Source files ==="
        ls -la "$MODULE_DIR"/*.c "$MODULE_DIR"/*.h 2>/dev/null || true
    
    - name: Build rwProcMem33
      run: |
        KERNEL_DIR=$(pwd)/kernel
        MODULE_DIR=$(pwd)/rwProcMem33/rwProcMem33Module/rwProcMem_module
        
        cd "$KERNEL_DIR"
        make -C "$KERNEL_DIR" M="$MODULE_DIR" \
          ARCH=arm64 \
          CROSS_COMPILE=aarch64-linux-gnu- \
          modules -j$(nproc)
        
        aarch64-linux-gnu-strip --strip-debug "$MODULE_DIR"/*.ko
        
        echo "=== Build result ==="
        ls -lh "$MODULE_DIR"/*.ko
    
    - name: Verify
      run: |
        MODULE_DIR=$(pwd)/rwProcMem33/rwProcMem33Module/rwProcMem_module
        
        echo "=== Module info ==="
        modinfo "$MODULE_DIR"/*.ko
        
        echo ""
        echo "=== Vermagic comparison ==="
        echo "Module  : $(modinfo "$MODULE_DIR"/*.ko | grep vermagic | sed 's/vermagic: *//')"
        echo "Expected: 5.10.136-android12-9-00020-gc9f59ef34367-ab9585114 SMP preempt mod_unload modversions aarch64"
    
    - name: Copy module
      run: |
        cp rwProcMem33/rwProcMem33Module/rwProcMem_module/*.ko ./
        ls -lh *.ko
    
    - uses: actions/upload-artifact@v4
      with:
        name: rwProcMem33-driver
        path: "*.ko"
