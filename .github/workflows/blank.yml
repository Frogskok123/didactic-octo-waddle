
name: Build rwProcMem33 (patched for 5.10)

on: 
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-aarch64-linux-gnu libelf-dev bc bison flex libssl-dev git
    
    - name: Clone rwProcMem33
      run: |
        git clone https://github.com/abcz316/rwProcMem33.git
    
    - name: Patch rwProcMem33 for kernel 5.10
      run: |
        cd rwProcMem33/rwProcMem33Module/rwProcMem_module
        
        echo "=== Patching linux_kernel_api.h ==="
        # Исправляем pte_mkwrite (kernel 5.10 требует 1 аргумент)
        sed -i 's/pte_mkwrite(pte, &vma)/pte_mkwrite(pte)/g' linux_kernel_api.h
        
        echo "=== Patching proc_maps_auto_offset.h ==="
        # Убираем VMA_ITERATOR и for_each_vma (нет в 5.10)
        sed -i '/VMA_ITERATOR/d' proc_maps_auto_offset.h
        sed -i 's/for_each_vma(iter, vma)/for (vma = mm->mmap; vma; vma = vma->vm_next)/g' proc_maps_auto_offset.h
        
        echo "=== Patching proc_maps.h ==="
        sed -i '/VMA_ITERATOR/d' proc_maps.h
        sed -i 's/for_each_vma(iter, vma)/for (vma = mm->mmap; vma; vma = vma->vm_next)/g' proc_maps.h
        
        echo "=== Patching hide_procfs_dir.h ==="
        # Исправляем filldir_t
        sed -i 's/bool my_filldir/int my_filldir/g' hide_procfs_dir.h
        sed -i 's/return true/return 0/g' hide_procfs_dir.h
        sed -i 's/return false/return 1/g' hide_procfs_dir.h
        
        echo "=== Patching Makefile (disable warnings) ==="
        # Добавляем -w для игнорирования всех warnings
        cat > Makefile << 'EOF'
MODULE_NAME := rwProcMem33
RESMAN_CORE_OBJS := rwProcMem_module.o

ccflags-y += -w

ifneq ($(KERNELRELEASE),)
\tobj-m := $(MODULE_NAME).o
\t$(MODULE_NAME)-objs := $(RESMAN_CORE_OBJS)
else
\tKDIR := /lib/modules/$(shell uname -r)/build
\t
all:
\tmake -C $(KDIR) M=$(PWD) modules

clean:
\trm -rf *.ko *.o *.mod .*.*.cmd *.mod.o *.mod.c *.symvers *.order .tmp_versions
endif
EOF
    
    - name: Download kernel
      run: |
        git clone --depth=1 --branch android12-5.10-lts \
          https://android.googlesource.com/kernel/common kernel
    
    - name: Configure kernel
      run: |
        cd kernel
        sed -i 's/^SUBLEVEL = .*/SUBLEVEL = 136/' Makefile
        sed -i 's|^EXTRAVERSION =.*|EXTRAVERSION = -android12-9-00020-gc9f59ef34367-ab9585114|' Makefile
        echo "" > .scmversion
        
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- gki_defconfig
        make ARCH=arm64 CROSS_COMPILE=aarch64-linux-gnu- modules_prepare -j$(nproc)
    
    - name: Build rwProcMem33
      run: |
        KERNEL_DIR=$(pwd)/kernel
        MODULE_DIR=$(pwd)/rwProcMem33/rwProcMem33Module/rwProcMem_module
        
        cd "$KERNEL_DIR"
        make -C "$KERNEL_DIR" M="$MODULE_DIR" \
          ARCH=arm64 \
          CROSS_COMPILE=aarch64-linux-gnu- \
          EXTRA_CFLAGS="-w" \
          modules -j$(nproc) || echo "Build completed with warnings"
        
        if [ -f "$MODULE_DIR"/*.ko ]; then
          aarch64-linux-gnu-strip --strip-debug "$MODULE_DIR"/*.ko
          echo "✅ Module built successfully!"
          ls -lh "$MODULE_DIR"/*.ko
        else
          echo "❌ Module build failed!"
          exit 1
        fi
    
    - name: Verify
      run: |
        MODULE_DIR=$(pwd)/rwProcMem33/rwProcMem33Module/rwProcMem_module
        modinfo "$MODULE_DIR"/*.ko
    
    - name: Copy module
      run: |
        cp rwProcMem33/rwProcMem33Module/rwProcMem_module/*.ko ./
        ls -lh *.ko
    
    - uses: actions/upload-artifact@v4
      with:
        name: rwProcMem33-patched
        path: "*.ko"
